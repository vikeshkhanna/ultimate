<!DOCTYPE HTML>
<html>
	<head>
		<title>Ultimate Tic Tac Toe</title>
			<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
			<script src="http://d3js.org/d3.v3.min.js"></script>
			<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
			<script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
			<script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

			<style>
				.hold
				{
					font-weight:bold;
				}

				.hold-X
				{
					color:red;
				}

				.hold-O
				{
					color:blue;
				}

				.playable
				{
					cursor:pointer;
				}

				.playable:hover
				{
					background-color: lightcoral;
				}

				table 
				{
					font-size:20px;
					border-collapse: collapse;
				}

				table tr:first-child td {
					border-top: 0;
				}
				table tr:last-child td {
					border-bottom: 0;
				}
				table tr td:first-child,
				table tr th:first-child {
					border-left: 0;
				}
				table tr td:last-child,
				table tr th:last-child {
					border-right: 0;
				}

				table.uboard td 
				{
					border: 2px solid black;
				}

				table.uboard tr td
				{
					padding:10px;
				}

				table.board tr td
				{
					padding:15px;
					width:50px;
					height:50px;
				}

				table.board td {
					border: 1px solid black;
				}
			</style>

			<script type="text/javascript">
				var X='X';
				var O='O';
				var Z='-';
				var current_state;

				function get_board_id(r, c)
				{
					return "r"+r+"c"+c;
				}

				function get_cell_id(r,c,i,j)
				{
					return get_board_id(r,c)+"i"+i+"j"+j;
				}

				function is_board_playable(r, c)
				{
					if(current_state.r===-1 || (current_state.r===r && current_state.c===c)){
						return true;
					}

					return false;
				}

				function deserialize(data)
				{
					var sample = ["X",
												"1 1",
												"---------",
												"---------", 
												"--X------",
												"---------",
												"----X----",
												"---------",
												"------O--",
												"---------",
												"---------"].join("\n");

					var list = sample.split("\n");
					player = list[0];
					pos = list[1].split(" ");
					r = parseInt(pos[0]);
					c = parseInt(pos[1]);

					list = list.slice(2);
					data = new Array(3);

					for(var i=0; i<3;i++)
					{
						data[i] = new Array(3);
						for(var j=0;j<3;j++)
						{
							data[i][j] = new Array(3);
							for(var k=0;k<3; k++)
							{
								data[i][j][k] = new Array(3);
							}
						}
					}

					for(var i=0;i<list.length;i++)
					{
						for(var j=0;j<list[i].length;j++)
						{
							br = Math.floor(i/3);
							bc = Math.floor(j/3);
							bri = i%3;
							brj = j%3;
							data[br][bc][bri][brj] = list[i][j];
						}
					}

					return {r:r, c:c, data:data};
				}


				function mark_current(r, c)
				{
					var current = d3.select("#"+get_board_id(1,1))
					current.style("background-color", "lightgreen");
					return current;
				}

				function make_board(udata)
				{
						r = udata.r;
						c = udata.c;

						data = [];

						for(var i=0;i<udata.data.length;i++)
						{
							data[i] = []

							for(var j=0;j<udata.data[i].length;j++)
							{
								data[i][j] = {}
								data[i][j].value = udata.data[i][j];
								data[i][j].i = i;
								data[i][j].j = j;
								data[i][j].r = r;
								data[i][j].c = c;
							}
						}

						var table = document.createElement("table");
						table = d3.select(table).attr("class", "board").attr("id", get_board_id(r,c));
						
						var thead = table.append("thead"),
								tbody = table.append("tbody");

							// Create a row for each object in the data
							var rows = tbody.selectAll("tr")
								.data(data)
								.enter()
								.append("tr");

							// Create a cell in each row for each column
							var cells = rows.selectAll("td")
							.data(function(row) {
										return row;
								})
							.enter()
							.append("td")
							.html(function(d) {
											if(d.value==Z){
												return " ";
											}
											return d.value;
										})
							.attr("id", function(d){
											return get_cell_id(r,c,d.i,d.j);
										})
							.attr("class", function(d){
										var val = current_state.data[d.r][d.c][d.i][d.j];
										if(val===Z && is_board_playable(d.r, d.c)){
											return "playable";	
										}
										else if(val===X)
										{
											return "hold hold-X";
										}
										else if(val===O)
										{
											return "hold hold-O";
										}
									})
							.on("click", function(d){
									if(d.value===Z && is_board_playable(d.r, d.c)){
										move = {r:d.r, c:d.c, i:d.i, j:d.j};
										evaluate(move);
										init();
									}
								});

						return table[0][0];
				}

				function evaluate(move)
				{
					alert(move.r);
				}

				function tabulate(data)
				{
						udata = Array(data.length);

						for(var i=0; i<data.length; i++)
						{
							udata[i] = Array(data[i].length);

							for(var j=0; j<data[i].length; j++)
							{
								udata[i][j] = {}
								udata[i][j].r = i;
								udata[i][j].c = j;
								udata[i][j].data = data[i][j];
							}
						}

						d3.select(".uboard").remove();
						var uboard = d3.select("body").append("table").attr("class", "uboard")
						ubody = uboard.append("tbody")

						var urows = ubody.selectAll("tr")
							.data(udata)
							.enter()
							.append("tr")

						var ucells = urows.selectAll("td")
								.data(function(row) {
									return row;
								})
							.enter()
							.append("td")
							.append(function(d){
								return make_board(d);
							});

							return uboard;
					}	

					function init()
					{
						current_state = deserialize();
						var uboard = tabulate(current_state.data);
						mark_current(current_state.r, current_state.c);

						for(var r=0; r<3;r++)
						{
							for(var c=0;c<3;c++)
							{
								for(var i=0; i<3;i++)
								{
									for(var j=0;j<3;j++)
									{
									}
								}
							}
						}
					}

					$(document).ready(function(){
						data = [
										[
											[[1,2,3],[4,5,6],[7,8,9]], 
											[[10, 11, 12], [13,14,15], [16,17,18]], 
											[[19,20,21],[22,23,24], [25,26,27]]
										],
										[
											[[1,2,3],[4,5,6],[7,8,9]], 
											[[10, 11, 12], [13,14,15], [16,17,18]], 
											[[19,20,21],[22,23,24], [25,26,27]]
										],
										[
											[[1,2,3],[4,5,6],[7,8,9]], 
											[[10, 11, 12], [13,14,15], [16,17,18]], 
											[[19,20,21],[22,23,24], [25,26,27]]
										]
									];
								init();
					});
			</script>
		</head>

		<body>
		</body>
</html>
