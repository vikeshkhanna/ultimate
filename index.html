<!DOCTYPE HTML>
<html>
	<head>
		<title>Ultimate Tic Tac Toe</title>
			<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
			<script src="http://d3js.org/d3.v3.min.js"></script>
			<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
			<script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
			<script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

			<style>
				.hold
				{
					font-weight:bold;
				}

				.win
				{
					font-weight:bold;
				}

				.hold-X
				{
					color:red;
				}

				.win-X
				{
					background-color:lightcoral;
				}

				.win-Y
				{
					background-color:lightblue;
				}

				.hold-O
				{
					color:blue;
				}

				.playable-board
				{
					background-color:lightgreen;				
				}

				.playable-cell
				{
					cursor:pointer;
				}

				.playable-cell:hover
				{
					background-color: lightcoral;
				}

				table 
				{
					font-size:20px;
					border-collapse: collapse;
				}

				table tr:first-child td {
					border-top: 0;
				}
				table tr:last-child td {
					border-bottom: 0;
				}
				table tr td:first-child,
				table tr th:first-child {
					border-left: 0;
				}
				table tr td:last-child,
				table tr th:last-child {
					border-right: 0;
				}

				table.uboard td 
				{
					border: 2px solid black;
				}

				table.uboard tr td
				{
					padding:10px;
				}

				table.board tr td
				{
					padding:15px;
					width:60px;
					height:60px;
					text-align:center;
				}

				table.board td {
					border: 1px solid black;
				}
			</style>

			<script type="text/javascript">
				var X='X';
				var O='O';
				var Z='-';
				var current_state = {}

				function get_board_id(r, c)
				{
					return "r"+r+"c"+c;
				}

				function get_opponent(player)
				{
					return (player===X?O:X);
				}

				function get_cell_id(r,c,i,j)
				{
					return get_board_id(r,c)+"i"+i+"j"+j;
				}

				function is_board_playable(r, c)
				{
					if(current_state.r===-1 || (current_state.r===r && current_state.c===c)){
						return true;
					}

					return false;
				}

				function is_super_winner(player)
				{
						winners = current_state.winners;

						for(var i=0; i<3; i++){
							if(winners[i][0].winner===player && winners[i][1].winner===player && winners[i][2].winner===player){
								return true;
							}

							if(winners[0][i].winner===player && winners[1][i].winner==m.player && winners[2][i].winner===player){
								return true;
							}
						}

						if(winners[0][0]===player && winners[1][1].winner===player && winners[2][2].winner===player){
							return true;
						}

						if(winners[0][2].winner===player && winners[1][1].winner===player && winners[2][0].winner===player){
							return true;
						}

					return false;
				}

				function deserialize(data)
				{
					var sample = ["X",
												"-1 -1",
												"---------",
												"---------", 
												"--X------",
												"---------",
												"----X----",
												"---------",
												"------O--",
												"---------",
												"---------"].join("\n");

					var list = sample.split("\n");
					player = list[0];
					pos = list[1].split(" ");
					r = parseInt(pos[0]);
					c = parseInt(pos[1]);

					list = list.slice(2);
					data = new Array(3);

					for(var i=0; i<3;i++)
					{
						data[i] = new Array(3);
						for(var j=0;j<3;j++)
						{
							data[i][j] = new Array(3);
							for(var k=0;k<3; k++)
							{
								data[i][j][k] = new Array(3);
							}
						}
					}

					for(var i=0;i<list.length;i++)
					{
						for(var j=0;j<list[i].length;j++)
						{
							br = Math.floor(i/3);
							bc = Math.floor(j/3);
							bri = i%3;
							brj = j%3;
							data[br][bc][bri][brj] = list[i][j];
						}
					}

					return {r:r, c:c, data:data};
				}


				function mark_current(r, c)
				{
					var current = d3.select("#"+get_board_id(1,1))
					return current;
				}

				function is_finished(r, c)
				{
					data = current_state.data;

					if(current_state.winners[r][c].winner!=null){
						return true;
					}

					for(var i=0;i<3;i++)
					{
						for(var j=0;j<3;j++)
						{
							if(data[r][c][i][j]===Z) 
								return false;
						}
					}

					return true;
				}

				function make_board(udata)
				{
						r = udata.r;
						c = udata.c;

						data = [];

						for(var i=0;i<udata.data.length;i++)
						{
							data[i] = []

							for(var j=0;j<udata.data[i].length;j++)
							{
								data[i][j] = {}
								data[i][j].value = udata.data[i][j];
								data[i][j].i = i;
								data[i][j].j = j;
								data[i][j].r = r;
								data[i][j].c = c;
							}
						}

						var table = document.createElement("table");
						table = d3.select(table)
							.attr("class", function(){ 
										var classes = "board ";
										if(is_board_playable(r, c)){
												classes += "playable-board";
											}
										return classes;
									})
							.attr("id", get_board_id(r,c));
						
						var thead = table.append("thead"),
								tbody = table.append("tbody");

							// Create a row for each object in the data
							var rows = tbody.selectAll("tr")
								.data(data)
								.enter()
								.append("tr");

							// Create a cell in each row for each column
							var cells = rows.selectAll("td")
							.data(function(row) {
										return row;
								})
							.enter()
							.append("td")
							.html(function(d) {
											if(d.value==Z){
												return " ";
											}
											return d.value;
										})
							.attr("id", function(d){
											return get_cell_id(r,c,d.i,d.j);
										})
							.attr("class", function(d){
										var val = current_state.data[d.r][d.c][d.i][d.j];

										if(val===Z && is_board_playable(d.r, d.c)){
											return "playable-cell";	
										}
		
										obj = current_state.winners[d.r][d.c];

										if(obj!=null && obj.winner!=null){
											classes = "win ";	
											cells = obj.cells;
											
											if(obj.winner===X){
												classes += "win-X";	
											}
											else{
												classes += "win-Y";
											}
	
											for(var i=0;i<cells.length;i++){
												if(cells[i][0]===d.i && cells[i][1]===d.j)
												{
													return classes;
												}
											}
										}
										
										if(val===X)
										{
											return "hold hold-X";
										}
										else if(val===O)
										{
											return "hold hold-O";
										}
									})
							.on("click", function(d){
									if(d.value===Z && is_board_playable(d.r, d.c)){
										move = {player: current_state.player, r:d.r, c:d.c, i:d.i, j:d.j};
										evaluate(move);
										restart();
									}
								});

						return table;
				}

				function evaluate(move)
				{
					m = move;
					console.log("Evaluating")
					console.log(m);

					data = current_state.data;
					board = data[m.r][m.c];
					board[m.i][m.j]=m.player;
					
					if(current_state.winners[m.r][m.c].winner===null){
						for(var i=0; i<3; i++){
							if(board[i][0]===m.player && board[i][1]===m.player && board[i][2]===m.player){
								current_state.winners[m.r][m.c] = { winner:m.player, cells: [[i,0],[i,1],[i,2]]};
								break;
							}

							if(board[0][i]===m.player && board[1][i]===m.player && board[2][i]===m.player){
								current_state.winners[m.r][m.c] = { winner:m.player, cells: [[0,i],[1,i],[2,i]]};
								break;
							}
						}

						if(board[0][0]===m.player && board[1][1]===m.player && board[2][2]===m.player){
							current_state.winners[m.r][m.c] = { winner:m.player, cells: [[0,0],[1,1],[2,2]]};
						}

						if(board[0][2]===m.player && board[1][1]===m.player && board[2][0]===m.player){
							current_state.winners[m.r][m.c] = { winner:m.player, cells: [[0,2],[1,1],[2,0]]};
						}
					}

					if(is_super_winner(X)){
						alert("You have won!");
					}
					current_state.r = is_finished(m.i, m.j) ? -1 : m.i;
					current_state.c = is_finished(m.i, m.j) ? -1 : m.j;
					current_state.player = get_opponent(m.player);
				}

				function tabulate(data)
				{
						udata = Array(data.length);

						for(var i=0; i<data.length; i++)
						{
							udata[i] = Array(data[i].length);

							for(var j=0; j<data[i].length; j++)
							{
								udata[i][j] = {}
								udata[i][j].r = i;
								udata[i][j].c = j;
								udata[i][j].data = data[i][j];
							}
						}

						d3.select(".uboard").remove();
						var uboard = d3.select("body").append("table").attr("class", "uboard")
						ubody = uboard.append("tbody")

						var urows = ubody.selectAll("tr")
							.data(udata)
							.enter()
							.append("tr")

						var ucells = urows.selectAll("td")
								.data(function(row) {
									return row;
								})
							.enter()
							.append("td")
							.append(function(d){
									var board = make_board(d);
									return board[0][0];
							});

							return uboard;
					}	

					function init()
					{
						current_state = deserialize();
						current_state.r = current_state.c = -1;
						current_state.player = X;
						current_state.winners = []
								
						for(var i=0; i<3; i++)
						{
							current_state.winners[i] = [];
							for(var j=0; j<3; j++)
							{
								current_state.winners[i][j] = {winner:null, cells:[]};
							}
						}

						restart();
					}

					function restart()
					{
						var uboard = tabulate(current_state.data);
						mark_current(current_state.r, current_state.c);
					}

					$(document).ready(function(){
						/*	
						data = [
										[
											[[1,2,3],[4,5,6],[7,8,9]], 
											[[10, 11, 12], [13,14,15], [16,17,18]], 
											[[19,20,21],[22,23,24], [25,26,27]]
										],
										[
											[[1,2,3],[4,5,6],[7,8,9]], 
											[[10, 11, 12], [13,14,15], [16,17,18]], 
											[[19,20,21],[22,23,24], [25,26,27]]
										],
										[
											[[1,2,3],[4,5,6],[7,8,9]], 
											[[10, 11, 12], [13,14,15], [16,17,18]], 
											[[19,20,21],[22,23,24], [25,26,27]]
										]
										]; 
						 */
							init();
					});
			</script>
		</head>

		<body>
		</body>
</html>
